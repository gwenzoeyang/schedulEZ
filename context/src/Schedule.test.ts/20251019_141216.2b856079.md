---
timestamp: 'Sun Oct 19 2025 14:12:16 GMT-0400 (Eastern Daylight Time)'
content_id: 2b85607988fd768355ebed231e74f16d8a016dfeaf65c01425e6ca9547be7bc7
---

# file: src/Schedule.test.ts

```typescript
import { assert, assertEquals, assertRejects, assertThrows } from "@std/assert";

import { MongoClient } from "mongodb";
import {
  type Course,
  CourseCatalog,
} from "/Users/gwen-zoeyang/schedulEZ/src/CourseCatalog.ts";
import {
  type AIRecommenderLike,
  Schedule,
} from "/Users/gwen-zoeyang/schedulEZ/src/Schedule.ts";

// ---------- helpers ----------------------------------------------------------

function getEnv(...names: string[]): string {
  for (const n of names) {
    // Deno first
    // deno-lint-ignore no-explicit-any
    const d = (globalThis as any).Deno?.env?.get?.(n);
    if (typeof d === "string" && d.length > 0) return d;
    // Node fallback (in case)
    // deno-lint-ignore no-explicit-any
    const p = (globalThis as any).process?.env?.[n];
    if (typeof p === "string" && p.length > 0) return p;
  }
  return "";
}

function errMessage(err: unknown): string {
  return err instanceof Error ? err.message : String(err);
}

async function loadCatalogFromMongo(): Promise<CourseCatalog> {
  const uri = getEnv("MONGODB_URI", "MONGODB_URL", "mongodb_url");
  if (!uri) {
    throw new Error("❌ Missing MongoDB URI (mongodb_url or MONGODB_URI).");
  }

  const dbName = getEnv("MONGODB_DB", "DB_NAME", "db_name");
  if (!dbName) {
    throw new Error("❌ Missing MongoDB DB name (db_name or MONGODB_DB).");
  }

  const collName = getEnv(
    "MONGODB_COLLECTION",
    "COLLECTION",
    "collection",
    "collection_name",
  ) ||
    "courses";

  const client = new MongoClient(uri);
  try {
    await client.connect();
    const rows = await client.db(dbName).collection(collName).find({})
      .toArray();
    if (!rows || rows.length === 0) {
      throw new Error(
        `❌ MongoDB connected, but collection "${collName}" is empty.`,
      );
    }
    return CourseCatalog.fromDbRows(rows as any);
  } catch (err: unknown) {
    throw new Error(
      `❌ Failed to connect to MongoDB or fetch data: ${errMessage(err)}`,
    );
  } finally {
    try {
      await client.close();
    } catch {}
  }
}

function toArray<T>(s: Set<T>): T[] {
  return [...s];
}

// Simple AI stub ensures determinism if Gemini is disabled
const FirstPickAI: AIRecommenderLike = {
  chooseCourse: (_owner, candidates) => candidates[0] ?? null,
};

// ---------- tests ------------------------------------------------------------

Deno.test("Schedule.addCourse adds and prevents duplicates (Mongo-backed)", async () => {
  const catalog = await loadCatalogFromMongo();
  const all = toArray(catalog.search());

  const sch = new Schedule(catalog, FirstPickAI);
  const user = { id: "u1" };

  const c1: Course = all[0];
  sch.addCourse(user, c1);
  assertEquals(sch.listSchedule(user).size, 1);

  assertThrows(
    () => sch.addCourse(user, c1),
    Error,
    `already in the schedule`,
  );
});

Deno.test("Schedule.listSchedule throws when empty (Mongo-backed)", async () => {
  const catalog = await loadCatalogFromMongo();
  const sch = new Schedule(catalog, FirstPickAI);
  const user = { id: "u1" };

  assertThrows(
    () => sch.listSchedule(user),
    Error,
    "schedule is empty",
  );
});

Deno.test("Schedule.suggestCourseAI chooses a candidate with fallback AI (Mongo-backed)", async () => {
  const catalog = await loadCatalogFromMongo();
  const all = toArray(catalog.search());

  const sch = new Schedule(catalog, FirstPickAI);
  const user = { id: "u1" };

  sch.setAIPreferences(user, "CS", new Set(["ai", "systems"]), new Set());
  const pick = await sch.suggestCourseAI(user);

  assert(pick && typeof pick.courseID === "string");
  const ids = new Set([...sch.listSchedule(user)].map((c) => c.courseID));
  assert(!ids.has(pick.courseID));
});

Deno.test("Schedule.updateAfterAddAI throws if prefs missing or course not present (Mongo-backed)", async () => {
  const catalog = await loadCatalogFromMongo();
  const all = toArray(catalog.search());
  const sch = new Schedule(catalog, FirstPickAI);
  const user = { id: "u1" };
  const c = all[0];

  // No prefs set
  await assertRejects(
    () => sch.updateAfterAddAI(user, c),
    Error,
    "aiPreferences not set",
  );

  // Set prefs but course not in schedule
  sch.setAIPreferences(user, "CS", new Set(), new Set());
  await assertRejects(
    () => sch.updateAfterAddAI(user, c),
    Error,
    "is not in the schedule",
  );
});

Deno.test("Schedule.clear removes all courses (Mongo-backed)", async () => {
  const catalog = await loadCatalogFromMongo();
  const all = toArray(catalog.search());
  if (all.length < 2) {
    throw new Error("❌ Need at least 2 courses in MongoDB for this test.");
  }

  const sch = new Schedule(catalog, FirstPickAI);
  const user = { id: "u1" };

  sch.addCourse(user, all[0]);
  sch.addCourse(user, all[1]);
  assertEquals(sch.listSchedule(user).size, 2);

  sch.clear(user);
  assertThrows(() => sch.listSchedule(user), Error, "schedule is empty");
});

```
